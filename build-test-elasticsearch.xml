<?xml version="1.0"?>

<project basedir="." name="portal-test-elasticsearch" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="build-test.xml" />

	<macrodef name="prepare-elasticsearch">
		<sequential>
			<chmod file="${elasticsearch.dir}/bin/**" perm="a+x" />

			<if>
				<os family="unix" />
				<then>
					<exec dir="${elasticsearch.dir}/bin" executable="/bin/bash">
						<arg value="-c" />
						<arg value="./plugin install ${elasticsearch.license.zip.url}" />
					</exec>

					<exec dir="${elasticsearch.dir}/bin" executable="/bin/bash">
						<arg value="-c" />
						<arg value="./plugin install ${elasticsearch.analysis-icu.zip.url}" />
					</exec>

					<exec dir="${elasticsearch.dir}/bin" executable="/bin/bash">
						<arg value="-c" />
						<arg value="./plugin install ${elasticsearch.analysis-kuromoji.zip.url}" />
					</exec>

					<exec dir="${elasticsearch.dir}/bin" executable="/bin/bash">
						<arg value="-c" />
						<arg value="./plugin install ${elasticsearch.analysis-smartcn.zip.url}" />
					</exec>

					<exec dir="${elasticsearch.dir}/bin" executable="/bin/bash">
						<arg value="-c" />
						<arg value="./plugin install ${elasticsearch.analysis-stempel.zip.url}" />
					</exec>

					<exec dir="${elasticsearch.dir}/bin" executable="/bin/bash">
						<arg value="-c" />
						<arg value="./plugin install ${marvel-agent.zip.url}" />
					</exec>
				</then>
				<elseif>
					<os family="windows" />
					<then>
						<exec dir="${elasticsearch.dir}/bin" executable="cmd">
							<arg value="/c" />
							<arg value="plugin install ${elasticsearch.license.zip.url}" />
						</exec>

						<exec dir="${elasticsearch.dir}/bin" executable="cmd">
							<arg value="/c" />
							<arg line="plugin install ${elasticsearch.analysis-icu.zip.url}" />
						</exec>

						<exec dir="${elasticsearch.dir}/bin" executable="cmd">
							<arg value="/c" />
							<arg line="plugin install ${elasticsearch.analysis-kuromoji.zip.url}" />
						</exec>

						<exec dir="${elasticsearch.dir}/bin" executable="cmd">
							<arg value="/c" />
							<arg line="plugin install ${elasticsearch.analysis-smartcn.zip.url}" />
						</exec>

						<exec dir="${elasticsearch.dir}/bin" executable="cmd">
							<arg value="/c" />
							<arg line="plugin install ${elasticsearch.analysis-stempel.zip.url}" />
						</exec>

						<exec dir="${elasticsearch.dir}/bin" executable="cmd">
							<arg value="/c" />
							<arg line="plugin install ${marvel-agent.zip.url}" />
						</exec>
					</then>
				</elseif>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="prepare-marvel">
		<sequential>
			<chmod file="${kibana.dir}/bin/**" perm="a+x" />

			<if>
				<os family="unix" />
				<then>
					<exec dir="${kibana.dir}/bin" executable="/bin/bash">
						<arg value="-c" />
						<arg value="./kibana plugin --install marvel --url ${marvel.zip.url}" />
					</exec>
				</then>
				<elseif>
					<os family="windows" />
					<then>
						<exec dir="${kibana.dir}/bin" executable="cmd">
							<arg value="/c" />
							<arg line="kibana plugin --install marvel --url ${marvel.zip.url}" />
						</exec>
					</then>
				</elseif>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="unzip-elasticsearch">
		<sequential>
			<delete dir="${elasticsearch.dir}" />

			<if>
				<not>
					<available file="${app.server.parent.dir}/${elasticsearch.zip.name}" />
				</not>
				<then>
					<mirrors-get
						dest="${app.server.parent.dir}/${elasticsearch.zip.name}"
						src="${elasticsearch.zip.url}"
						verbose="true"
					/>
				</then>
			</if>

			<unzip
				dest="${app.server.parent.dir}"
				src="${app.server.parent.dir}/${elasticsearch.zip.name}"
			/>
		</sequential>
	</macrodef>

	<macrodef name="unzip-kibana">
		<sequential>
			<delete dir="${app.server.parent.dir}/${kibana.zip.name.windows}" />

			<delete dir="${app.server.parent.dir}/${kibana.tar.name.linux}" />

			<delete dir="${app.server.parent.dir}/${kibana.tar.name.mac}" />

			<if>
				<and>
					<not>
						<available file="${app.server.parent.dir}/${kibana.zip.name}" />
					</not>
					<os family="windows" />
				</and>
				<then>
					<mirrors-get
						dest="${app.server.parent.dir}/${kibana.zip.name.windows}"
						src="${kibana.zip.url.windows}"
						verbose="true"
					/>

					<unzip
						dest="${app.server.parent.dir}"
						src="${app.server.parent.dir}/${kibana.zip.name.windows}"
					/>
				</then>
				<elseif>
					<not>
						<available file="${app.server.parent.dir}/${kibana.tar.name.mac}" />
					</not>
					<os family="mac" />
					<then>
						<mirrors-get
							dest="${app.server.parent.dir}/${kibana.tar.name.mac}"
							src="${kibana.tar.url.mac}"
							verbose="true"
						/>

						<untar
							compression="gzip"
							dest="${app.server.parent.dir}"
							src="${app.server.parent.dir}/${kibana.tar.name.mac}"
						/>
					</then>
				</elseif>
				<elseif>
					<not>
						<available file="${app.server.parent.dir}/${kibana.tar.name.linux}" />
					</not>
					<os family="unix" />
					<then>
						<mirrors-get
							dest="${app.server.parent.dir}/${kibana.tar.name.linux}"
							src="${kibana.tar.url.linux}"
							verbose="true"
						/>

						<untar
							compression="gzip"
							dest="${app.server.parent.dir}"
							src="${app.server.parent.dir}/${kibana.tar.name.linux}"
						/>
					</then>
				</elseif>
			</if>

			<delete dir="${kibana.dir}" />

			<if>
				<os family="windows" />
				<then>
					<copy todir="${kibana.dir}">
					   <fileset dir="${app.server.parent.dir}/kibana-${kibana.version}-windows" />
					</copy>

					 <delete dir="${app.server.parent.dir}/kibana-${kibana.version}-windows" />
				</then>
				<elseif>
					<os family="mac" />
					<then>
						<copy todir="${kibana.dir}">
						   <fileset dir="${app.server.parent.dir}/kibana-${kibana.version}-darwin-x64" />
						</copy>

						<delete dir="${app.server.parent.dir}/kibana-${kibana.version}-darwin-x64" />
					</then>
				</elseif>
				<elseif>
					<os family="unix" />
					<then>
						<copy todir="${kibana.dir}">
						   <fileset dir="${app.server.parent.dir}/kibana-${kibana.version}-linux-x64" />
						</copy>

						<delete dir="${app.server.parent.dir}/kibana-${kibana.version}-linux-x64" />
					</then>
				</elseif>
			</if>
		</sequential>
	</macrodef>

	<target name="configure-elasticsearch-osgi-bundle-properties">
		<echo file="${liferay.home}/osgi/configs/com.liferay.portal.search.elasticsearch.configuration.ElasticsearchConfiguration.cfg">operationMode=REMOTE
logExceptionsOnly=false</echo>
	</target>

	<target name="start-elasticsearch">
		<unzip-elasticsearch />

		<replace file="${elasticsearch.dir}/config/elasticsearch.yml">
			<replacetoken><![CDATA[# cluster.name: my-application]]></replacetoken>
			<replacevalue><![CDATA[cluster.name: LiferayElasticsearchCluster]]></replacevalue>
		</replace>

		<prepare-elasticsearch />

		<antcall target="configure-elasticsearch-osgi-bundle-properties" />

		<local name="elasticsearch.server.not.started" />

		<if>
			<os family="unix" />
			<then>
				<exec dir="${elasticsearch.dir}/bin" executable="/bin/bash">
					<arg value="-c" />
					<arg value="./elasticsearch -Des.insecure.allow.root=true -d -p pid-elasticsearch" />
				</exec>

				<waitfor maxwait="10" maxwaitunit="second" timeoutproperty="elasticsearch.server.not.started">
					<http url="http://localhost:9200/" />
				</waitfor>

				<fail if="elasticsearch.server.not.started" message="Elasticsearch server failed to initialize." />
			</then>
			<elseif>
				<os family="windows" />
				<then>
					<exec dir="${elasticsearch.dir}/bin" executable="cmd" spawn="true">
						<arg value="/c" />
						<arg value="elasticsearch -d -p pid-elasticsearch" />
					</exec>

					<waitfor maxwait="10" maxwaitunit="second" timeoutproperty="elasticsearch.server.not.started">
						<http url="http://localhost:9200/" />
					</waitfor>

					<fail if="elasticsearch.server.not.started" message="Elasticsearch server failed to initialize." />
				</then>
			</elseif>
		</if>
	</target>

	<target name="start-marvel-kibana">
		<unzip-kibana />

		<replace file="${kibana.dir}/config/kibana.yml">
			<replacetoken><![CDATA[# server.basePath: ""]]></replacetoken>
			<replacevalue><![CDATA[server.basePath: "/o/portal-search-elasticsearch-marvel-web/marvel-proxy"]]></replacevalue>
		</replace>

		<prepare-marvel />

		<if>
			<os family="unix" />
			<then>
				<exec dir="${kibana.dir}/bin" executable="/bin/bash">
					<arg value="-c" />
					<arg value="./kibana" />
				</exec>
			</then>
			<elseif>
				<os family="windows" />
				<then>
					<exec dir="${kibana.dir}/bin" executable="cmd">
						<arg value="/c" />
						<arg value="kibana" />
					</exec>
				</then>
			</elseif>
		</if>
	</target>

	<target name="stop-elasticsearch">
		<if>
			<os family="unix" />
			<then>
				<loadfile property="pid-elasticsearch" srcFile="${elasticsearch.dir}/bin/pid-elasticsearch">
					<filterchain>
						<linecontainsregexp>
							<regexp pattern="[0-9]*" />
						</linecontainsregexp>
					</filterchain>
				</loadfile>

				<exec dir="${elasticsearch.dir}/bin" executable="/bin/bash">
					<arg value="-c" />
					<arg value="kill ${pid-elasticsearch}" />
				</exec>
			</then>
			<elseif>
				<os family="windows" />
				<then>
					<exec dir="${elasticsearch.dir}/bin" executable="cmd" spawn="true">
						<arg value="/c" />
						<arg value="for /f %x in (pid-elasticsearch) do taskkill /f /pid %x" />
					</exec>
				</then>
			</elseif>
		</if>
	</target>
</project>